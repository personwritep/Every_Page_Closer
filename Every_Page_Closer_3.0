// ==UserScript==
// @name        Every Page Closer ğŸ’¢
// @namespace        http://tampermonkey.net/
// @version        3.0
// @description        ã€Œè¨˜äº‹ã®ç·¨é›†ãƒ»å‰Šé™¤ã€ãƒšãƒ¼ã‚¸ã§å…¨è¨˜äº‹ã‚’ã€Œä¸‹æ›¸ãã€ã«å¤‰æ›´ã™ã‚‹
// @author        Ameba Blog User
// @match        https://blog.ameba.jp/ucs/entry/srventrylist*
// @match        https://blog.ameba.jp/ucs/entry/srventryupdate*
// @run-at        document-start
// @grant        none
// @updateURL        https://github.com/personwritep/Every_Page_Closer/raw/main/Every_Page_Closer.user.js
// @downloadURL        https://github.com/personwritep/Every_Page_Closer/raw/main/Every_Page_Closer.user.js
// ==/UserScript==


let retry=0;
let interval=setInterval(wait_target, 1);
function wait_target(){
    retry++;
    if(retry>100){ // ãƒªãƒˆãƒ©ã‚¤åˆ¶é™ 100å› 0.1secã¾ã§
        clearInterval(interval); }
    let target=document.documentElement; // ç›£è¦– target
    if(target){
        clearInterval(interval);
        style_in(); }}

function style_in(){
    let style=
        '<style id="EPC">'+
        '#globalHeader, #ucsHeader, #ucsMainLeft h1, #ucsMainRight, .l-ucs-sidemenu-area, '+
        '.selection-bar { display: none !important; } '+

        '#ucsContent { width: 930px !important; } '+
        '#ucsContent::before { display: none; } '+
        '#ucsMain { background: none; } '+
        '#ucsMainLeft { width: 930px !important; padding: 0 15px !important; } '+

        '#entryMonth li a:visited { color: #3970B5 !important; }'+
        '#nowMonth { color: #000; } '+
        '#entryListEdit form { display: flex; flex-direction: column; } '+
        '#entrySort { order: -2; margin-bottom: 2px; } '+
        '#sorting { font-size: 15px; margin: 36px 0 4px; padding: 2px 0; height: 40px; } '+
        '#sorting select, #sorting ul { display: none; } '+
        '.pagingArea { order: -1; '+
        'margin-bottom: -33px; position:unset !important; background: #ddedf3; } '+
        '.pagingArea a { border: 1px solid #888; } '+
        '.pagingArea .active{ border: 2px solid #0066cc; } '+
        '.pagingArea a, .pagingArea .active, .pagingArea .disabled { '+
        'font-size: 14px; line-height: 23px; } '+

        '#sorting input { font-family: meiryo; font-size: 15px }'+
        '.entry-item .checkbox-column { display: block; } '+
        '#start_button { padding: 2px 8px 0; margin: 6px 15px; width: 200px } '+
        '#all_button {padding: 2px 8px 0; margin: 6px 0 6px 120px; width: 145px } '+
        '#am_button {padding: 2px 8px 0; margin: 6px 15px; width: 270px; float: right } '+
        '</style>';

    if(!document.querySelector('#EPO')){
        document.documentElement.insertAdjacentHTML('beforeend', style); }

} // style_in()




window.addEventListener('load', function(){
    let auto_check; // ãƒã‚§ãƒƒã‚¯è‡ªå‹•è¨˜å…¥ã®ãƒ•ãƒ©ã‚°
    let amember; // ã‚¢ãƒ¡ãƒ³ãƒãƒ¼å‡¦ç†ã®æœ‰ç„¡ã®ãƒ•ãƒ©ã‚°

    auto_check=localStorage.getItem('blogDB_mode_check'); // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
    if(!auto_check){
        auto_check=0; }
    localStorage.setItem('blogDB_mode_check', auto_check); // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä¿å­˜

    amember=localStorage.getItem('blogDB_mode_am'); // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
    if(!amember){
        amember=0; }
    localStorage.setItem('blogDB_mode_am', amember); // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä¿å­˜


    let mode_arr=[]; // mode_arr[0]è‡ªå‹•ãƒªãƒ­ãƒ¼ãƒ‰ã®ãƒ•ãƒ©ã‚°ã€mode_arr[1]åˆå›å‡¦ç†ã®ãƒ•ãƒ©ã‚°

    let read_json=sessionStorage.getItem('blogDB_mode'); // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ ä¿å­˜
    mode_arr=JSON.parse(read_json);
    if(!mode_arr || mode_arr.length!=3){
        mode_arr=[0, 0, 0]; }


    if(mode_arr[0]==1){ // å¤‰æ›´å‡¦ç†å¾Œã®è‡ªå‹•ãƒ­ãƒ¼ãƒ‰å¾Œã®å ´åˆ
        mode_arr[0]=0; // ãƒªã‚»ãƒƒãƒˆ
        let write_json=JSON.stringify(mode_arr);
        sessionStorage.setItem('blogDB_mode', write_json); //  // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä¿å­˜
        setTimeout(()=>{
            location.reload(false); }, 2000 ); }// ãƒ„ãƒ¼ãƒ«ã‹ã‚‰å†ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹
    else{
        main(mode_arr, auto_check, amember); }

})




function main(mode_arr, auto_check, amember){

    check();

    function check(){
        let spui=document.querySelectorAll('.spui-Checkbox-input');
        for(let k=1; k<spui.length; k++){
            set_check(spui[k]); }

        function set_check(sp){
            if(auto_check==0){
                let publish=sp.getAttribute('data-entry-publish');
                if(publish=='0' || publish=='1'){
                    sp.checked=true; }
                else if(publish=='2'){
                    if(amember==0){
                        sp.checked=true; }
                    else{
                        sp.checked=false; }}}
            else{
                sp.checked=false; }}

    } // check()



    let panel=
        '<input id="start_button" type="submit" value="â–¼ ã‚¯ãƒ­ãƒ¼ã‚ºå‡¦ç†ã‚’å®Ÿè¡Œ">'+
        '<input id="all_button" type="submit">'+
        '<input id="am_button" type="submit">';

    if(document.querySelector('#sorting') && !document.querySelector('#start_button')){
        document.querySelector('#sorting').insertAdjacentHTML('beforeend', panel); }



    let button1=document.querySelector('#start_button');
    button1.onclick=function(e){
        e.preventDefault();
        if(mode_arr[1]==0){ // æœ€åˆã®èµ·å‹•ç›´å¾Œã®å ´åˆ
            start_select(); }
        else{
            open_win(); }} // ä½œæ¥­å®Ÿè¡Œ



    function start_select(){
        let entry_target=document.querySelectorAll('.entry-item .entry');
        if(entry_target.length==0 || entry_target==null){ // ç·¨é›†å¯¾è±¡ãŒãƒªã‚¹ãƒˆã«ç„¡ã„å ´åˆ
            alert('ã“ã®ãƒšãƒ¼ã‚¸ã«ç·¨é›†å¯¾è±¡ã®è¨˜äº‹ãŒã‚ã‚Šã¾ã›ã‚“'); }
        if(entry_target.length >0){ // ç·¨é›†å¯¾è±¡ãŒãƒªã‚¹ãƒˆã«æœ‰ã‚‹å ´åˆ
            let conf_str=['â›”ã€€ ã“ã®ãƒšãƒ¼ã‚¸ã§ ã€Œä¸‹æ›¸ãã€ã¸ã®ä¸€æ‹¬å¤‰æ›´å‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚\n',
                          '\nã€€ã€€ Every Page Closer ğŸ’¢ ã®å®Ÿè¡Œå‰ã« Every Page Snap ğŸ’¢',
                          '\nã€€ã€€ ã‚’å®Ÿè¡Œã—ã¦ã€å…¨ã¦ã®è¨˜äº‹ã® ã€Œå…¬é–‹è¨­å®šã€ ã‚’è¨˜éŒ²ã—ã¦ãã ã•ã„ã€‚',
                          '\nã€€ã€€ ã€Œå…¬é–‹è¨­å®šã€ ã®SNAPè¨˜éŒ²ãŒç„¡ã„ã¨ ã€Œã‚¢ãƒ¡ãƒ³ãƒãƒ¼é™å®šå…¬é–‹ã€ ã¨',
                          '\nã€€ã€€ ã€Œå…¨å“¡ã«å…¬é–‹ã€ ã®åŒºåˆ¥ãŒãªããªã‚Š å…¬é–‹å‡¦ç†ãŒå›°é›£ã«ãªã‚Šã¾ã™ã€‚\n',
                          '\nã€€ã€€ã€€ã€€ã€€ã€€OK ã‚’æŠ¼ã™ã¨ ã€Œã‚¯ãƒ­ãƒ¼ã‚ºå‡¦ç†ã€ ã‚’é–‹å§‹ã—ã¾ã™ã€‚'].join('');
            let ok=confirm(conf_str);
            if(ok){
                open_win(); }}}



    let button2=document.querySelector('#all_button');
    if(auto_check==0){
        button2.value='âœ…  å…¨ä»¶ãƒã‚§ãƒƒã‚¯'; }
    else{
        button2.value='â¬œ  å…¨ä»¶ãƒã‚§ãƒƒã‚¯'; }

    button2.onclick=function(e){
        e.preventDefault();
        if(auto_check==0){
            auto_check=1;
            button2.value='â¬œ  å…¨ä»¶ãƒã‚§ãƒƒã‚¯'; }
        else{
            auto_check=0;
            button2.value='âœ…  å…¨ä»¶ãƒã‚§ãƒƒã‚¯'; }
        localStorage.setItem('blogDB_mode_check', auto_check); // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä¿å­˜

        check(); }



    let button3=document.querySelector('#am_button');
    if(amember==0){
        button3.value='ğŸ”½  ã‚¢ãƒ¡ãƒ³ãƒãƒ¼è¨˜äº‹ã‚‚ã‚¯ãƒ­ãƒ¼ã‚ºã™ã‚‹'; }
    else if(amember==1){
        button3.value='â¬œ  ã‚¢ãƒ¡ãƒ³ãƒãƒ¼è¨˜äº‹ã¯å‡¦ç†ã‚’ã—ãªã„'; }

    button3.onclick=function(e){
        e.preventDefault();
        if(amember==0){
            amember=1;
            button3.value='â¬œ  ã‚¢ãƒ¡ãƒ³ãƒãƒ¼è¨˜äº‹ã¯å‡¦ç†ã‚’ã—ãªã„'; }
        else if(amember==1){
            amember=0;
            button3.value='ğŸ”½  ã‚¢ãƒ¡ãƒ³ãƒãƒ¼è¨˜äº‹ã‚‚ã‚¯ãƒ­ãƒ¼ã‚ºã™ã‚‹'; }
        localStorage.setItem('blogDB_mode_am', amember); // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä¿å­˜

        check(); }



    function open_win(){
        let convert=document.querySelector('#js-convert-to-draft-button-convert');
        if(convert){
            mode_arr[0]=1; // æ›¸æ›å‡¦ç†ã‚’å®Ÿè¡Œ
            mode_arr[1]=1; // åˆå›ã®å®Ÿè¡Œä»¥é™
            let write_json=JSON.stringify(mode_arr);
            sessionStorage.setItem('blogDB_mode', write_json); // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ ä¿å­˜

            convert.click(); }}

} // main()

